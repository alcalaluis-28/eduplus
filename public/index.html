<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Eduplus</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body { background-color: #f4f6f9; }
    header { background: linear-gradient(135deg, #0d6efd, #6610f2); color: white; padding: 2rem 0; }
    .titulo-app { font-weight: 700; }
    .card:hover { transform: translateY(-5px); transition: 0.2s; }
    .btn-agregar { border-radius: 50%; }
    hr { margin-top: 3rem; margin-bottom: 2rem; }
  </style>
</head>
<body>
  <header class="text-center">
    <h1 class="titulo-app"><i class="fa-solid fa-graduation-cap"></i> EDUPLUS</h1>
    <p class="mb-0">Administración de categorías y cursos</p>
  </header>

  <div class="container mt-4">
    <h2 class="mt-4 mb-3 text-primary"><i class="fa-solid fa-layer-group"></i> Categorías</h2>
    <div id="listaCategorias" class="row g-3"></div>

    <hr>
    <h2 class="mb-3 text-success"><i class="fa-solid fa-book"></i> Cursos</h2>
    <div id="listaCursos" class="row g-3"></div>
  </div>

  <!-- Menú flotante -->
  <div class="btn-group dropup position-fixed bottom-0 end-0 m-4">
    <button class="btn btn-primary btn-lg rounded-circle dropdown-toggle btn-agregar" data-bs-toggle="dropdown">
      <i class="fa-solid fa-plus"></i>
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
      <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalCategoria">Agregar Categoría</a></li>
      <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalSubcategoria" onclick="cargarCategorias()">Agregar Subcategoría</a></li>
      <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalProfesor">Agregar Profesor</a></li>
      <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalCurso" onclick="cargarSelects()">Agregar Curso</a></li>
    </ul>
  </div>

  <!-- MODAL CATEGORÍA -->
  <div class="modal fade" id="modalCategoria" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5>Agregar Categoría</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="text" id="nombreCategoria" class="form-control" placeholder="Nombre de la categoría">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarCategoria()">Guardar</button>
      </div>
    </div></div>
  </div>

  <!-- MODAL SUBCATEGORÍA -->
  <div class="modal fade" id="modalSubcategoria" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5>Agregar Subcategoría</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <select id="categoriaSub" class="form-select mb-2"></select>
        <input type="text" id="nombreSubcategoria" class="form-control" placeholder="Nombre de la subcategoría">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarSubcategoria()">Guardar</button>
      </div>
    </div></div>
  </div>

  <!-- MODAL PROFESOR -->
  <div class="modal fade" id="modalProfesor" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5>Agregar Profesor</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="text" id="nombreProfesor" class="form-control mb-2" placeholder="Nombres">
        <input type="text" id="apellidoProfesor" class="form-control" placeholder="Apellidos">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarProfesor()">Guardar</button>
      </div>
    </div></div>
  </div>

  <!-- MODAL CURSO -->
  <div class="modal fade" id="modalCurso" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5>Agregar Curso</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-3">
          <label>Título del curso</label>
          <input type="text" id="tituloCurso" class="form-control">
        </div>
        <div class="mb-3">
          <label>Subcategoría</label>
          <select id="subcategoriaCurso" class="form-select"></select>
        </div>
        <div class="mb-3">
          <label>Profesor</label>
          <select id="profesorCurso" class="form-select"></select>
        </div>
        <div class="mb-3">
          <label>Precio (S/)</label>
          <input type="number" id="precioCurso" class="form-control" step="0.01">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-success" onclick="guardarCurso()">Guardar</button>
      </div>
    </div></div>
  </div>

  <script>
    // ===================== CATEGORÍAS =====================
    fetch('/api/categorias')
      .then(res => res.json())
      .then(data => {
        const contenedor = document.getElementById('listaCategorias');
        contenedor.innerHTML = data.length
          ? data.map(cat => `
            <div class="col-md-4">
              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <h5><i class="fa-solid fa-tag"></i> ${cat.nombre}</h5>
                  <button class="btn btn-danger btn-sm mt-2" onclick="eliminarCategoria(${cat.id_cat})">
                    <i class="fa-solid fa-trash"></i> Eliminar
                  </button>
                </div>
              </div>
            </div>`).join('')
          : `<div class="text-center text-muted"><i class="fa-solid fa-circle-info fa-2x mb-2"></i><p>No hay categorías</p></div>`;
      });

    function guardarCategoria() {
      const nombre = document.getElementById('nombreCategoria').value.trim();
      if (!nombre) return alert('Escribe un nombre');
      fetch('/api/categorias', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({nombre}) })
      .then(res=>res.ok?location.reload():alert('Error al guardar'));
    }

    function eliminarCategoria(id) {
      if (!confirm('¿Eliminar esta categoría?')) return;
      fetch(`/api/categorias/${id}`, { method: 'DELETE' }).then(()=>location.reload());
    }

    // ===================== SUBCATEGORÍAS =====================
    function cargarCategorias(){
      fetch('/api/categorias')
        .then(r=>r.json())
        .then(cats=>{
          const sel = document.getElementById('categoriaSub');
          sel.innerHTML = '';
          cats.forEach(c=> sel.innerHTML += `<option value="${c.id_cat}">${c.nombre}</option>`);
        });
    }

    function guardarSubcategoria(){
      const id_cat = document.getElementById('categoriaSub').value;
      const nombre = document.getElementById('nombreSubcategoria').value.trim();
      if(!id_cat || !nombre) return alert('Completa todos los campos');
      fetch('/api/subcategorias', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ id_cat, nombre })
      })
      .then(r=>{
        if(r.ok){
          alert('✅ Subcategoría agregada');
          cargarSelects();
        }else{
          alert('❌ Error al agregar subcategoría');
        }
      });
    }

    // ===================== CURSOS =====================
    fetch('/api/cursos')
      .then(res => res.json())
      .then(data => {
        const contenedor = document.getElementById('listaCursos');
        contenedor.innerHTML = data.length
          ? data.map(curso => `
            <div class="col-md-4">
              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <h5 class="text-success"><i class="fa-solid fa-book"></i> ${curso.titulo}</h5>
                  <p>
                    <strong>Subcategoría:</strong> ${curso.subcategoria_nombre}<br>
                    <strong>Profesor:</strong> ${curso.docente_nombre || 'Sin asignar'}<br>
                    <strong>Precio:</strong> S/ ${curso.precio}
                  </p>
                  <button class="btn btn-danger btn-sm" onclick="eliminarCurso(${curso.id_curso})">
                    <i class="fa-solid fa-trash"></i> Eliminar
                  </button>
                </div>
              </div>
            </div>`).join('')
          : `<div class="text-center text-muted"><i class="fa-solid fa-circle-info fa-2x mb-2"></i><p>No hay cursos</p></div>`;
      });

    function eliminarCurso(id) {
      if (!confirm('¿Eliminar este curso?')) return;
      fetch(`/api/cursos/${id}`, { method: 'DELETE' }).then(()=>location.reload());
    }

    // ===================== SELECTS =====================
    function cargarSelects() {
      fetch('/api/subcategorias')
        .then(res => res.json())
        .then(subs => {
          const s = document.getElementById('subcategoriaCurso');
          s.innerHTML = '<option value="">Seleccione...</option>';
          subs.forEach(sc => s.innerHTML += `<option value="${sc.id_sub}">${sc.categoria_nombre} › ${sc.nombre}</option>`);
        });

      fetch('/api/profesores')
        .then(res => res.json())
        .then(prof => {
          const s = document.getElementById('profesorCurso');
          s.innerHTML = '<option value="">Seleccione...</option>';
          prof.forEach(p => s.innerHTML += `<option value="${p.id_doc}">${p.nombres} ${p.apellidos}</option>`);
        });
    }

    // ===================== GUARDAR CURSO =====================
    function guardarCurso() {
      const titulo = document.getElementById('tituloCurso').value.trim();
      const id_sub = document.getElementById('subcategoriaCurso').value;
      const id_doc = document.getElementById('profesorCurso').value;
      const precio = Number(document.getElementById('precioCurso').value || 0);
      if (!titulo || !id_sub || !id_doc) return alert('Completa todos los campos');
      fetch('/api/cursos', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ titulo, id_sub, id_doc, precio })
      })
      .then(res => res.ok ? location.reload() : alert('Error al guardar curso'));
    }

    // ===================== PROFESOR =====================
    function guardarProfesor() {
      const nombres = document.getElementById('nombreProfesor').value.trim();
      const apellidos = document.getElementById('apellidoProfesor').value.trim();
      if (!nombres || !apellidos) return alert('Completa ambos campos');
      fetch('/api/profesores', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ nombres, apellidos })
      })
      .then(res => {
        if(res.ok){
          alert('✅ Profesor agregado');
          cargarSelects();
        }else{
          alert('❌ Error al agregar');
        }
      });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
